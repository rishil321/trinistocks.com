{% extends "covid19/base.html" %}
{% load static %}

    {% block rightsidebarform %}
    <form action="{% url 'covid19:totals' %}" method="get">
        <label for="startdate" class="w3-bar-item">Start Date</label>
        <input class="w3-bar-item w3-theme-l5" type="date" value="{{ enteredstartdate }}" id="startdate" name="startdate">
        <label for="enddate" class="w3-bar-item">End Date</label>
        <input class="w3-bar-item w3-theme-l5" type="date" value="{{ enteredenddate }}" id="enddate" name="enddate">
        <label for="selectedcasetypeleft" class="w3-bar-item">Left Axis</label>
        <select class="w3-bar-item w3-theme-l5 w3-button-2" id="selectedcasetypeleft" name="selectedcasetypeleft">
        {% for casetype in validcasetypes %}
            {% if casetype.attname == selectedcasetypeleftstr %}
                <option value="{{ casetype.attname }}" selected>{{casetype.verbose_name}}</option>
            {% else %}
                <option value="{{ casetype.attname }}">{{casetype.verbose_name}}</option>
            {% endif %}
        {% endfor %}
        </select>
        <label for="selectedcasetyperight" class="w3-bar-item">Right Axis</label>
        <select class="w3-bar-item w3-theme-l5 w3-button-2" id="selectedcasetyperight" name="selectedcasetyperight">
        {% for casetype in validcasetypes %}
            {% if casetype.attname == selectedcasetyperightstr %}
                <option value="{{ casetype.attname }}" selected>{{casetype.verbose_name}}</option>
            {% else %}
                <option value="{{ casetype.attname }}">{{casetype.verbose_name}}</option>
            {% endif %}
        {% endfor %}
        </select>
        </br>
        <button style="" class="w3-bar-item w3-theme-l2 w3-button-2 w3-hover-theme w3-center" type="submit">Run Query &nbsp<i class="fa fa-database"></i></button>
    </form>
    {% endblock rightsidebarform %}

    {% block maindiv %}
    {% if errors != '' %}
        <p>{{errors}}</p>
    {% else %}
    {% block pagetitle %}
        <h2 class="w3-center" style="" id="charttitle">
        T&T Covid-19 Cumulative Data</h2>
    {% endblock pagetitle %}
    </br>
    <div class="w3-cell-row">
        <div class="w3-container w3-blue w3-cell w3-mobile">
            <p class="">{{ latestrecord.numtested }} testing samples submitted &ensp;
            <i class="fas fa-microscope fa-2x"></i></p>
        </div>
        <div class="w3-container w3-yellow w3-cell w3-mobile">
            <p>{{ latestrecord.numpositive }} persons tested positive &ensp; 
            <i class="fas fa-procedures fa-2x"></i></p>
        </div>
        <div class="w3-container w3-green w3-cell w3-mobile">
            <p>{{ latestrecord.numrecovered }} person(s) discharged &ensp; 
            <i class="fas fa-virus-slash fa-2x"></i></p>
        </div>
        <div class="w3-container w3-red w3-cell w3-mobile">
            <p>{{ latestrecord.numdeaths }} person(s) died &ensp; 
            <i class=" far fa-heart fa-2x"></i></p>
        </div>
    </div>
    </br>
        <!-- Chart -->
        <div style="height:40rem;width:auto;" id="chartdiv" class="chartdiv">
            <canvas id="covid19chart">
                Covid19 Chart
            </canvas>
        </div>
    {% endif %}
    {% endblock maindiv %}

    <!-- END MAIN -->
    
    <!--Javascript-->
    
    {% block chartjs %}
    {{ graphlabels|json_script:"graphlabels" }}
    {{ graphdataset|json_script:"graphdataset" }}
    <script>
    var ctx = document.getElementById('covid19chart').getContext("2d");
    //load in our graph date labels from the python context
    var graphlabels = JSON.parse(document.getElementById('graphlabels').textContent);
    //convert the datetime into moments for Javascript
    var i;
    for (i=0;i<graphlabels.length;i++){
        graphlabels[i] = new Date(graphlabels[i])
    }
    //load the actual dataset values 
    var graphdataset = JSON.parse(document.getElementById('graphdataset').textContent);
    //set the font size
    Chart.defaults.global.defaultFontSize = 18;
    var myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: graphlabels,
            datasets: graphdataset
        },
        options: {
            responsive: false,
            maintainAspectRatio: false,
            scales: {
                xAxes: [{
                scaleLabel: {
                    display: true,
                    labelString: 'Date'},
                type: 'time',
                distribution: 'linear'
					}],
                yAxes: [{
                    id:'A',
                    scaleLabel: {
                        display: true,
                        labelString: '{{ selectedcasetypeleftverbose|escapejs }}'},
                    type:'linear',
                    position:'left',
                },
                {
                    id:'B',
                    scaleLabel: {
                        display: true,
                        labelString: '{{ selectedcasetyperightverbose|escapejs }}'},
                    type:'linear',
                    position:'right',
                },
                ]            
        }
        }
    });
    //get the div holding the canvas
    const chartdiv = document.getElementById("chartdiv");
    //create a resize observer to resize our chart
    const ro = new ResizeObserver( entries => {
    for (let entry of entries) {
        ctx.canvas.width = chartdiv.clientWidth;
        myChart.resize();
        myChart.update();
    }
    });
    // Observe one or multiple elements
    ro.observe(chartdiv);
    </script>
    {% endblock chartjs %}
    
    {% block highlightpage%}
    $(cumulativelink).toggleClass("w3-theme-l3");
    {% endblock highlightpage %}

    {% block morejs %}
    <script>
    </script>
    {% endblock morejs %}